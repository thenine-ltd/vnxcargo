!function(s,t,c){"use strict";var r=s.wp,a=s._,l=s.TMEPOADMINLOOKUPJS,d=s.toastr,o=s.plupload,e={tc_builder_elements:r.template("tc-builder-elements"),tc_builder_section:r.template("tc-builder-section")},m=l.lookuptable;function u(){var i,n={},s={},l={};return c(".lookup-table").toArray().forEach(function(e){e=c(e),i=e.closest(".lookup-table-wrap").prev(".lookuptable-name").find(".table-name-value").text(),n[i]={},e.find(".row").toArray().forEach(function(e){c(e).find(".ltcell").toArray().forEach(function(e){var t,o,e=c(e),a=e.attr("data-row"),r=e.attr("data-column"),e=e.text();"1"===a&&"1"===r||(t=e.replace(/,/g,"."),o=c.epoAPI.math.toFloat(t),e="max"!==t&&isNaN(o)?0:t,"1"===r?l[a]=e:"1"===a?s[r]=e:(void 0===n[i][s[r]]&&(n[i][s[r]]={}),n[i][s[r]][l[a]]=e))})})}),n}c.tmEPOAdmin={addEventsDone:0,addEvents:function(){var n,e=c("#builder_import_file"),e=new o.Uploader({url:l.ajax_url,browse_button:e[0],file_data_name:"builder_import_file",multi_selection:!1});e.init(),e.bind("FilesAdded",function(e){function t(){c("#tc-floatbox-content").find(".override-selection").addClass("tc-hidden"),o.appendTo("#tc-floatbox-content"),c(".tc-progress-info-content").html(l.i18n_importing),e.setOption("multipart_params",{action:"tc_lookup_table_import",post_id:l.post_id,security:l.import_nonce}),e.start(),c(".flasho").addClass("tc-color-notice")}var o,a=c.tmEPOAdmin.builder_floatbox_template_import({id:"tc-floatbox-content",html:"",title:l.i18n_import_title});n=c.tcFloatBox({closefadeouttime:0,animateOut:"",fps:1,ismodal:!0,refresh:"fixed",width:"50%",height:"300px",classname:"flasho tc-wrapper",data:a}),o=c('<div class="tc-progress-bar tc-notice"><span class="tc-percent"></span></div><div class="tc-progress-info"><span class="tc-progress-info-content"></span></div>'),c(".lookuptable-wrapper").length?(c('<div class="override-selection"><button type="button" class="tc tc-button details-override">'+l.i18n_overwrite_existing_tables+"</button></div>").appendTo("#tc-floatbox-content"),c(".details-override").on("click",function(){t()})):t()}),e.bind("FileUploaded",function(e,t,o){var a,r,i=c.epoAPI.util.parseJSON(o.response);i&&void 0!==i.result&&i.message&&c(".tc-progress-info-content").html(i.message),i&&i.error&&i.message&&c(".tc-progress-info-content").html(i.message),i&&void 0!==i.result&&1===c.epoAPI.math.toFloat(i.result)?(c(".tc-progress-bar").removeClass("tc-notice").addClass("tc-success"),c(".tc-progress-info-content").removeClass("tc-color-error").addClass("tc-color-success"),c(".flasho").removeClass("tc-color-notice tc-color-error").addClass("tc-color-success"),c(".floatbox-cancel").addClass("tc-hidden"),c(".tc-progress-info-content").html(l.i18n_saving),c(s).off("beforeunload.edit-post"),i.table?Array.isArray(i.jsobject)?(c(".builder-layout").html(i.table),c.tmEPOAdmin.initSectionsCheck(),d.success(i.message,l.i18n_epo),(a=c("#title")).length&&""===a.val()&&(a.val(Object.keys(i.jsobject[0])[0]),c("#title-prompt-text").addClass("screen-reader-text"),"publish"===c("#publish").attr("name")&&c("#publish").trigger("click"))):d.error(l.i18n_invalid_request,l.i18n_epo):i.different?(r=1,c(".details-override").on("click",function(){c.post(l.ajax_url,{action:"tc_lookup_table_import",import_override:1,post_id:l.post_id,security:l.import_nonce},function(e){(i=e).table&&(Array.isArray(i.jsobject)?(c(".builder-layout").html(i.table),c.tmEPOAdmin.initSectionsCheck(),d.success(i.message,l.i18n_epo)):d.error(l.i18n_invalid_request,l.i18n_epo))},"json").always(function(){n.destroy()})}),c("#tc-floatbox-content").find(".override-selection").removeClass("tc-hidden").addClass("height50").insertAfter(c(".tc-progress-info")),c(".floatbox-cancel").removeClass("tc-hidden"),c(".tc-progress-bar").addClass("tc-hidden"),c(".tc-progress-info-content").removeClass("tc-color-success tc-color-error").addClass("tc-color-notice").html(i.message),c(".flasho").removeClass("tc-color-success tc-color-error").addClass("tc-color-notice")):d.error(l.i18n_invalid_csv,l.i18n_epo),r||n.destroy()):(c(".tc-progress-bar").removeClass("tc-notice").addClass("tc-error"),c(".tc-progress-info-content").removeClass("tc-color-success").addClass("tc-color-error"),c(".flasho").removeClass("tc-color-notice tc-color-success").addClass("tc-color-error"),!i&&o&&o.response&&c(".tc-progress-info-content").addClass("tc-normalize").html(o.response),d.error(l.i18n_invalid_request,l.i18n_epo))}),e.bind("UploadProgress",function(e,t){t=parseInt(t.percent,10);c(".tc-progress-bar").css("width",t+"%"),c(".tc-percent").html(t+"%")}),e.bind("Error",function(e,t){t&&t.message&&c(".tc-progress-info-content").removeClass("tc-color-success").addClass("tc-color-error").html("\nError #"+t.code+": "+t.message),c(".tc-progress-bar").removeClass("tc-notice").addClass("tc-error"),c(".flasho").removeClass("tc-color-notice tc-color-success").addClass("tc-color-error"),t&&t.response&&(c(".flasho .header h3").html(t.message),c(".tc-progress-info-content").addClass("tc-normal-font").html(t.response)),d.error(l.i18n_invalid_request,l.i18n_epo)}),e.bind("UploadComplete",function(){c("body").removeClass("overflow")}),c(t).on("click.cpf",".tc-add-import-csv",function(e){e.preventDefault(),c("#builder_import_file").trigger("click")}),c(t).on("click.cpf",".tc-add-export-csv",function(e){var t=c(this);e.preventDefault(),t.data("doing_export")||(t.data("doing_export",1).prepend('<i class="tm-icon tcfa tcfa-spin tcfa-spinner"></i>'),e={action:"tc_lookup_table_export",metaserialized:JSON.stringify(m),security:l.export_nonce},c.post(l.ajax_url,e,function(e){e&&e.result&&""!==e.result?s.location=e.result:(e=e&&e.error&&e.message?e.message:l.i18n_error_message,e=c.tmEPOAdmin.builder_floatbox_template_import({id:"tc-floatbox-content",html:'<div class="tm-inner">'+e+"</div>",title:l.i18n_error_title}),c.tcFloatBox({closefadeouttime:0,animateOut:"",fps:1,ismodal:!0,refresh:"fixed",width:"50%",height:"300px",classname:"flasho tc-wrapper tm-error",data:e}))},"json").always(function(){t.data("doing_export",0).find(".tm-icon").remove()}))}),c(t).on("mouseover",".ltcell",function(){var e=c(this),t=e.parent().parent().parent(),o=e.parent().parent(),a=c(t).data("vertable")+"",r=e.data("column")+"",e=e.data("row")+" .column1";c(o).find("."+r).addClass("hov-column-"+a),c(t).find(".row.head ."+r).addClass("hov-column-head-"+a),c(t).find(".row."+e).addClass("hov-column-head-"+a)}),c(t).on("mouseout",".ltcell",function(){var e=c(this),t=e.parent().parent().parent(),o=e.parent().parent(),a=c(t).data("vertable")+"",r=e.data("column")+"",e=e.data("row")+" .column1";c(o).find("."+r).removeClass("hov-column-"+a),c(t).find(".row.head ."+r).removeClass("hov-column-head-"+a),c(t).find(".row."+e).removeClass("hov-column-head-"+a)}),c(t).on("keypress",'[contenteditable="true"]',function(e){13===e.which&&(e.preventDefault(),c(this).trigger("blur"))}),c(t).on("focus",'[contenteditable="true"]',function(){var e=c(this);e.attr("data-value",e.text())}),c(t).on("blur",'[contenteditable="true"]',function(){var e,t=c(this),o=t.text().replace(/,/g,"."),a=c.epoAPI.math.toFloat(o),r={symbol:"",format:"",decimal:""===l.tm_epo_global_displayed_decimal_separator?l.currency_format_decimal_sep:c.epoAPI.locale.getSystemDecimalSeparator(),thousand:"",precision:function e(t){var o,t=String(t);return t.includes("e-")?(o=t.split("e-"),Number(o[1])+Number(e(o[0]))):t.includes(".")?t.split(".")[1].length:0}(a)},i=t.attr("data-row"),n=t.attr("data-column"),s=t.attr("data-value");if(void 0===s&&(s=0),t.is(".table-name-value"))""===o&&t.html(s);else if(e=t.closest("table").find("tr").length,""===o){if("1"===n||"1"===i)return void t.html(s)}else if("max"===o){if(1<Number(i)){if(Number(i)<e||1<Number(n))return void t.html(s)}else if(1===Number(i)&&Number(n)<=t.siblings().length)return void t.html(s);t.html(o)}else isNaN(a)||isNaN(Number(o))?t.html(s):(""!==o&&(o=c.epoAPI.math.format(o,r)),t.html(o));m=u()})},tm_escape:function(e){return encodeURIComponent(e)},createLookuptableMeta:function(){var e,t=c("input#wp-preview"),o=c("#tmformfieldsbuilderwrap");a.isEqual(l.lookuptable,m)||(c(".lookuptable-meta").remove(),e=c.tmEPOAdmin.tm_escape(JSON.stringify(m)),e=c("<textarea class='lookuptable-meta tm-hidden' name='lookuptable_meta_changed'></textarea>").val(e),o.prepend(e),0<t.length&&""!==t.val()&&c(".lookuptable-meta").remove())},fixFormSubmit:function(){var a,e=c("#post");1===e.length?e.on("submit",function(){return c.tmEPOAdmin.createLookuptableMeta(),!0}):r.data&&void 0!==r.data.subscribe&&(a=!1,"function"==typeof(e=r.data.subscribe)&&e(function(){var e,t,o;r.data.select("core/editor")&&(t=r.data.select("core/editor").didPostSaveRequestSucceed(),o=r.data.select("core/editor").didPostSaveRequestFail(),r&&r.data&&r.data.select("core/editor")&&(e=r.data.select("core/editor").isSavingPost()),!a&&e&&(a=!0,c.tmEPOAdmin.createLookuptableMeta()),a&&(t||o)&&(a=!1,setTimeout(function(){c(".lookuptable-meta").remove()},600)))}))},initialitize:function(){c.tmEPOAdmin.initSectionsCheck(),c.tmEPOAdmin.addEvents(),c(".builder-layout").removeClass("tm-hidden"),c.tmEPOAdmin.fixFormSubmit()},initSectionsCheck:function(){c(".lookuptable-wrapper").length?(c(".builder-add-section-action").show(),c(".builder-selector").show(),c(".tc-welcome").hide(),c(".builder-layout").show(),c(".tc-add-export-csv").show()):(c(".builder-add-section-action").hide(),c(".builder-selector").hide(),c(".tc-welcome").show(),c(".builder-layout").hide(),c(".tc-add-export-csv").hide())},builder_floatbox_template:function(e,t){return c.epoAPI.template.html(r.template(t||"tc-floatbox"),{id:e.id,title:e.title,html:e.html,uniqidtext:e.uniqidtext||"",uniqid:e.uniqid,update:e.update||l.i18n_update,cancel:e.cancel||l.i18n_cancel})},builder_floatbox_template_import:function(e){return c.epoAPI.template.html(r.template("tc-floatbox-import"),{id:e.id,title:e.title,html:e.html,cancel:l.i18n_cancel})}},c(function(){e=c.epoAPI.applyFilter("tc_adjust_admin_template_engine",e),c.tmEPOAdmin.initialitize()})}(window,document,window.jQuery);